#!/bin/env php
<?php
/**
 * @author stev leibelt <artodeto@bazzline.net>
 * @since 2015-10-09
 */

//begin of including composer autoload.php
$possiblePathsToComposerAutoloadFile = array(
    __DIR__ . '/../../../autoload.php',
    __DIR__ . '/../../vendor/autoload.php',
    __DIR__ . '/../vendor/autoload.php'
);
$pathToAutoloadFileNotFound = true;
$pathToAutoloadFile         = null;
foreach ($possiblePathsToComposerAutoloadFile as $path) {
    if (file_exists($path)) {
        $pathToAutoloadFile         = $path;
        $pathToAutoloadFileNotFound = false;
        break;
    }
}
if ($pathToAutoloadFileNotFound) {
    echo 'could not find composer autoload.php, no composer installed?' . PHP_EOL;
    exit(1);
}

require_once $pathToAutoloadFile;
//end of including composer autoload.php

use Net\Bazzline\Component\Command\Command;
use Net\Bazzline\Component\Cli\Arguments\Arguments;

function echoIfWanted($isWanted, $string)
{
    if ($isWanted) {
        echo $string . PHP_EOL;
    }
}

try {
    //begin of dependencies
    $usage      = basename(__FILE__) . ' <branch to create release from> <release branch name> <branch to merge into> [<branch to merge into> [...]] [-v|--verbose]';
    $arguments  = new Arguments($argv);
    $command    = new Command();
    //end of dependencies

    //begin of arguments parsing and validation
    $beVerbose          = ($arguments->hasFlag('verbose') || $arguments->hasFlag('v'));
    $values             = $arguments->getValues();
    $valuesAreInvalid   = (count($values) < 3);

    if ($valuesAreInvalid) {
        throw new RuntimeException(
            'invalid number of arguments provided'
        );
    }

    $branchToCreateReleaseFrom  = array_shift($values);
    $releaseBranchName          = array_shift($values);
    $branchesToMerge            = $values;
    //end of arguments parsing and validation

    //begin of remembering of current branch
    $lines          = $command('/bin/env git status');
    $currentBranch  = substr($lines[0], 10);  // = >>On branch <<
    //end of remembering of current branch

    //begin of business logic
    echoIfWanted($beVerbose, 'switching to branch "' . $branchToCreateReleaseFrom);
    $command('/bin/env git checkout ' . $branchToCreateReleaseFrom);
    echoIfWanted($beVerbose, 'updating branch');
    $command('/bin/env git pull ' . $branchToCreateReleaseFrom);
    echoIfWanted($beVerbose, 'creating branch "' . $releaseBranchName . '"');
    $command('/bin/env git checkout -b ' . $releaseBranchName);

    foreach ($branchesToMerge as $branchToMerge) {
        echoIfWanted($beVerbose, 'trying to merge "' . $branchToMerge . '"');
        $command('/bin/env git merge --no-ff ' . $branchToMerge);
        echoIfWanted($beVerbose, 'committing merge');
        $command('/bin/env git commit -m "merged ' . $branchToMerge . '"');
    }

    echoIfWanted($beVerbose, 'pushing branch "' . $releaseBranchName . '"');
    $command('/bin/env git push origin ' . $releaseBranchName);

    echoIfWanted($beVerbose, 'switching back to "' . $currentBranch . '"');
    $command('/bin/env git checkout ' . $currentBranch);
    //end of business logic
} catch (Exception $exception) {
    echo 'An error occurred' . PHP_EOL;
    echo $exception->getMessage() . PHP_EOL;
    echo PHP_EOL;
    echo $usage;
    echo PHP_EOL;
    exit(1);
}